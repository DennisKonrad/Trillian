---

# prechecks for required vars
- hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Check that mgmt server baseurl is defined
      fail:
        msg: "upgrade_baseurl_mgmt is required"
      when: upgrade_baseurl_mgmt is undefined and upgrade_rooturl is undefined
    
    - name: Check that kvm baseurl is defined if kvm hosts exist
      fail: msg="upgrade_baseurl_kvm is required as there are KVM hosts present"
      when: upgrade_baseurl_kvm is undefined and ( groups['kvm_hosts']|length > 0 )
    
    - name: Check upgrade version is specified
      fail: msg="upgrade version is required"
      when: upgrade_cloudstack_ver is undefined
    
# Perform upgrade
    
    - local_action:
        module: cs_template
        name: def_system_templates.{{ upgrade_cloudstack_ver }}.vmware_url
        url: def_system_templates.{{ upgrade_cloudstack_ver }}.vmware_systemvm_name
        hypervisor: VMware
        format: OVA
        cross_zones: yes
        os_type: Debian GNU/Linux 7(64-bit)
      when: vmware_ver|lower != "na"
    
    - local_action:
        module: cs_template
        name: "{{ def_system_templates[upgrade_cloudstack_ver].xs_systemvm_name }}"
        url: "{{ def_system_templates[upgrade_cloudstack_ver].xs_url }}"
        hypervisor: XenServer
        format: VHD
        cross_zones: yes
        os_type: Debian GNU/Linux 7(64-bit)
      when: xs_ver|lower != "na"
    
    - local_action:
        module: cs_template
        name: def_system_templates.{{ upgrade_cloudstack_ver }}.kvm_url
        url: def_system_templates.{{ upgrade_cloudstack_ver }}.kvm_systemvm_name
        hypervisor: KVM
        format: QCOW2
        cross_zones: yes
        os_type: Debian GNU/Linux 7(64-bit)
      when:  kvm_os|lower != "na"


- hosts: cloudstack_manager_hosts
  gather_facts: no
  tasks:

    - set_fact:
        numversion: "{{ upgrade_cloudstack_ver[2:3] }}.{{ upgrade_cloudstack_ver[3:6] }}"
      when: upgrade_cloudstack_ver[0:2] == "cs"
    
    - set_fact:
        numversion: "{{ upgrade_cloudstack_ver[3:4] }}.{{ upgrade_cloudstack_ver[4:7] }}"
      when: upgrade_cloudstack_ver[0:3] == "ccp"
 
    - set_fact:
        upgrade_baseurl_mgmt: "{{ upgrade_rooturl }}{{ baseurl_mgmt_suffix }}{{ numversion }}/"
      when: upgrade_baseurl_mgmt is undefined

    - name: Upgrade CloudStack Mgmt Server
      include: roles/cloudstack-manager/tasks/upgrade_mgmt.yaml


- hosts: kvm_hosts
  gather_facts: no
  tasks:
    - set_fact:
        upgrade_baseurl_kvm: "{{ upgrade_rooturl }}{{ baseurl_kvm_suffix }}{{ numversion }}/"
      when: upgrade_baseurl_kvm is undefined

    - name: Upgrade KVM hosts
      include: roles/cloudstack-manager/tasks/upgrade_kvm.yaml
      when: groups['kvm_hosts']|length > 0

- hosts: cloudstack_manager_hosts
  gather_facts: no
  tasks:

  - name: Test for API on 8080 on primary management host before configuring secondary
    shell: "curl http://127.0.0.1:8080/client/api --connect-timeout 5"
    register: result
    until: result.stdout.find("unable to verify user") != -1
    retries: 50
    run_once: true