---

#Copyright 2016 ShapeBlue
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing, software
#distributed under the License is distributed on an "AS IS" BASIS,
#WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#See the License for the specific language governing permissions and
#limitations under the License.

## update status - basic tags

- name: get timestamp
  command: date +'%H:%M %D'
  register: mydate

- name: Tag project
  shell: cs createTags resourceids={{ env_project_id }} resourcetype=project tags[{{ item.tagno }}].key={{ item.tagkey }} tags[{{ item.tagno }}].value={{ item.tagval }}
  with_items:
    - { tagno: 0, tagkey: 'env_name', tagval: "{{ env_name_clean }}" }
    - { tagno: 1, tagkey: 'env_uuid', tagval: "{{ env_uuid }}" }
    - { tagno: 2, tagkey: 'env_user', tagval: "{{ env_user }}" }
    - { tagno: 3, tagkey: 'state', tagval: 'Deploying_VMs' }
    - { tagno: 4, tagkey: 'created', tagval: "{{ mydate.stdout | regex_replace(' ', '_') }}" }
    - { tagno: 4, tagkey: 'comment', tagval: "{{ env_comment | regex_replace(' ', '_') }}" }
  async: 60
  poll: 1
  ignore_errors: true
  when: project_tag == "basetags"

## update status

- name: Delete current tag (key - 3) for project
  shell: cs deleteTags resourceids={{ env_project_id }} resourcetype=project tags[{{ item.tagno }}].key={{ item.tagkey }}
  with_items:
    - { tagno: 3, tagkey: 'state' }
  when: project_tag != "basetags"


- name: Create new tag (key - 3) for project
  shell: cs createTags resourceids={{ env_project_id }} resourcetype=project tags[{{ item.tagno }}].key={{ item.tagkey }} tags[{{ item.tagno }}].value={{ item.tagval }}
  with_items:
    - { tagno: 3, tagkey: 'state', tagval: "{{ project_tag }}" }
  when: project_tag != "basetags"
