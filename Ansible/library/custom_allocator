#!/bin/bash
##############################################################
#
#Returns host
#####################################################################################
# Vars
#


ARGS="(`cat $1`)"

ALGORITHM=`echo $ARGS | tr " " "\n"| awk -F= '$1=="ALGORITHM"{print $2}'| tr -d '"' | sed -e 's/[[:space:]]*$//'`
CLUSTERID=`echo $ARGS | tr " " "\n"| awk -F= '$1=="CLUSTERID"{print $2}'| tr -d '"' | sed -e 's/[[:space:]]*$//'`
PODID=`echo $ARGS | tr " " "\n"| awk -F= '$1=="PODID"{print $2}'| tr -d '"' | sed -e 's/[[:space:]]*$//'` ## FOR LATER
METRIC=`echo $ARGS | tr " " "\n"| awk -F= '$1=="METRIC"{print $2}'| tr -d '"' | sed -e 's/[[:space:]]*$//'` ## FOR LATER

function least_cluster()
{
  CLUSTERLID_ARRAY=(`cloudmonkey list clusters | jq -r '.cluster[]|.id'`)
  LOWESTCLUSTERID=""
  LOWESTMETRIC=9999999
  for (( i = 0; i < ${#CLUSTERLID_ARRAY[@]}; i++ )); do
    THISMETRIC=`cloudmonkey list capacity clusterid=${CLUSTERLID_ARRAY[$i]} type=1 | jq -r '.capacity[]|.percentused'`
    if [[ `echo $THISMETRIC'<'$LOWESTMETRIC | bc -l` = 1 ]]; then
      LOWESTMETRIC=$THISMETRIC
      LOWESTCLUSTERID=${CLUSTERLID_ARRAY[$i]}
    fi
  done

  echo $LOWESTCLUSTERID
}

function least_host()
{
  HOSTUSE=`cloudmonkey list hosts type=routing | jq '.host[]' | sed 's/\%//'`
  LOWESTHOSTID=`echo $HOSTUSE | jq -s -c 'sort_by(.cpuused|tonumber) | .[1] | .id'`
  echo $LOWESTHOSTID
}

function least_host_in_cluster()
{
  HOSTUSE=`cloudmonkey list hosts type=routing clusterid=$LOWESTCLUSTERID| jq '.host[]' | sed 's/\%//'`
  LOWESTHOSTID=`echo $HOSTUSE | jq -s -c 'sort_by(.cpuused|tonumber) | .[1] | .id'`
  echo $LOWESTHOSTID
}


################################################################################
# ReturnFact:
# Return parsed environment info
#
function ReturnFact()
{
cat << EOF
{
"ansible_facts": {
  "host_id": "${LOWESTHOSTID}",
  "env_return": "success",
  "env_retmsg": "Host with lowest use returned."
 }
}
EOF
WriteOutput "ReturnFact - returning facts to Ansible."
}



## DO STUFF

if [[ "$ALGORITHM" == "least_host" ]]; then
  HOSTUSE=`cloudmonkey list hosts type=routing | jq '.host[]'`
  HOSTUSE_SORTED=`echo $HOSTUSE | jq -s -c 'sort_by(.cpuused) | .[]'`
fi



case "$ALGORITHM" in
  least_host)
    WriteOutput "finding least used host";
    least_host;
    ReturnFact;
  ;;
  least_host_least_cluster)
    WriteOutput "finding least used cluster";
    least_cluster;
    WriteOutput "finding least used host in least used cluster";
    least_host_in_cluster;
    ReturnFact;
  ;;

esac
exit